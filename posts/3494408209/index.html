<!doctype html><html lang=zh-cn><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=referrer content="no-referrer"><meta content="飞鸿踏雪" name=author><title>浅析网站 PV/UV 统计系统的原理及其设计 - 元视角</title>
<meta name=description content="文章主要讨论了如何设计一个 PV/UV 统计系统，以应对互联网产品流量分析的需求。首先介绍了PV（页面浏览量）和 UV（独立访客数）的概念，并探讨了在不同情况下对 PV/UV 的理解，如 AJAX和单页面应用中 PV 的统计方式。接着，提出了在前端通过埋点收集数据的共识，并讨论了后端处理数据的三种方法：使用 Nginx 的 access_log、Redis 的 Hyperloglog 和 LeanCloud 的 Hooks。文章详细描述了这三种方法的实现过程，并通过实例代码展示了如何应用这些技术进行数据统计。最后，作者分享了在设计统计系统时遇到的问题和对使用 Linux 服务器的重要性的认识，并提供了相关项目的 GitHub 链接，供读者参考。"><link rel=icon type=image/png href=/images/favicons/favicon-96x96.png sizes=96x96><link rel=icon type=image/svg+xml href=/images/favicons/favicon.svg><link rel="shortcut icon" href=/images/favicons/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/images/favicons/apple-touch-icon.png><meta name=apple-mobile-web-app-title content="元视角"><link rel=manifest href=/site.webmanifest><meta name=keywords content="访问量,Nginx,Hyperlog"><meta property="og:title" content="浅析网站 PV/UV 统计系统的原理及其设计 - 元视角"><meta property="og:description" content="文章主要讨论了如何设计一个 PV/UV 统计系统，以应对互联网产品流量分析的需求。首先介绍了PV（页面浏览量）和 UV（独立访客数）的概念，并探讨了在不同情况下对 PV/UV 的理解，如 AJAX和单页面应用中 PV 的统计方式。接着，提出了在前端通过埋点收集数据的共识，并讨论了后端处理数据的三种方法：使用 Nginx 的 access_log、Redis 的 Hyperloglog 和 LeanCloud 的 Hooks。文章详细描述了这三种方法的实现过程，并通过实例代码展示了如何应用这些技术进行数据统计。最后，作者分享了在设计统计系统时遇到的问题和对使用 Linux 服务器的重要性的认识，并提供了相关项目的 GitHub 链接，供读者参考。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.yuanpei.me/posts/3494408209/"><meta property='og:site_name' content='元视角'><meta property="og:image" content="/images/avatar.jpg"><meta property="twitter:image" content="/images/avatar.jpg"><meta property='article:section' content='Posts'><meta property='article:tag' content='访问量'><meta property='article:tag' content='Nginx'><meta property='article:tag' content='Hyperlog'><meta property='article:published_time' content='2019-10-22T12:50:49+00:00'><meta property='article:modified_time' content='2019-10-22T12:50:49+00:00'><meta property="twitter:domain" content="https://blog.yuanpei.me/"><meta property="twitter:url" content="https://blog.yuanpei.me/"><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog.yuanpei.me/posts/3494408209/"><meta property="twitter:title" content="浅析网站 PV/UV 统计系统的原理及其设计 - 元视角"><meta property="twitter:description" content="文章主要讨论了如何设计一个 PV/UV 统计系统，以应对互联网产品流量分析的需求。首先介绍了PV（页面浏览量）和 UV（独立访客数）的概念，并探讨了在不同情况下对 PV/UV 的理解，如 AJAX和单页面应用中 PV 的统计方式。接着，提出了在前端通过埋点收集数据的共识，并讨论了后端处理数据的三种方法：使用 Nginx 的 access_log、Redis 的 Hyperloglog 和 LeanCloud 的 Hooks。文章详细描述了这三种方法的实现过程，并通过实例代码展示了如何应用这些技术进行数据统计。最后，作者分享了在设计统计系统时遇到的问题和对使用 Linux 服务器的重要性的认识，并提供了相关项目的 GitHub 链接，供读者参考。"><meta name=twitter:site content="飞鸿踏雪"><meta name=twitter:creator content="飞鸿踏雪"><link rel=stylesheet href=/styles/main.min.bb9e9eadbf718b0c91c89c85c701c072a4eaa3846575271b714abf3bc7bb8210.css><link rel=dns-prefetch crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/misans@4.1.0/lib/Normal/MiSans-Medium.min.css><link rel=dns-prefetch crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/misans@4.1.0/lib/Normal/MiSans-Bold.min.css><link rel=stylesheet href=/styles/iconfont.css><link rel=stylesheet href=/styles/iconfont-patch.css><script defer src=https://umami.yuanpei.me/JXOS5H5V data-website-id=445bd2eb-68f9-47fd-b93a-5dfa92be333d></script></head><body><div class="background patterns"><div class=bg-mask></div></div><style>.background{position:fixed;top:0;left:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;z-index:-2;&.patterns { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192' viewBox='0 0 192 192'%3E%3Cpath fill='%23494849' fill-opacity='0.08' d='M192 15v2a11 11 0 0 0-11 11c0 1.94 1.16 4.75 2.53 6.11l2.36 2.36a6.93 6.93 0 0 1 1.22 7.56l-.43.84a8.08 8.08 0 0 1-6.66 4.13H145v35.02a6.1 6.1 0 0 0 3.03 4.87l.84.43c1.58.79 4 .4 5.24-.85l2.36-2.36a12.04 12.04 0 0 1 7.51-3.11 13 13 0 1 1 .02 26 12 12 0 0 1-7.53-3.11l-2.36-2.36a4.93 4.93 0 0 0-5.24-.85l-.84.43a6.1 6.1 0 0 0-3.03 4.87V143h35.02a8.08 8.08 0 0 1 6.66 4.13l.43.84a6.91 6.91 0 0 1-1.22 7.56l-2.36 2.36A10.06 10.06 0 0 0 181 164a11 11 0 0 0 11 11v2a13 13 0 0 1-13-13 12 12 0 0 1 3.11-7.53l2.36-2.36a4.93 4.93 0 0 0 .85-5.24l-.43-.84a6.1 6.1 0 0 0-4.87-3.03H145v35.02a8.08 8.08 0 0 1-4.13 6.66l-.84.43a6.91 6.91 0 0 1-7.56-1.22l-2.36-2.36A10.06 10.06 0 0 0 124 181a11 11 0 0 0-11 11h-2a13 13 0 0 1 13-13c2.47 0 5.79 1.37 7.53 3.11l2.36 2.36a4.94 4.94 0 0 0 5.24.85l.84-.43a6.1 6.1 0 0 0 3.03-4.87V145h-35.02a8.08 8.08 0 0 1-6.66-4.13l-.43-.84a6.91 6.91 0 0 1 1.22-7.56l2.36-2.36A10.06 10.06 0 0 0 107 124a11 11 0 0 0-22 0c0 1.94 1.16 4.75 2.53 6.11l2.36 2.36a6.93 6.93 0 0 1 1.22 7.56l-.43.84a8.08 8.08 0 0 1-6.66 4.13H49v35.02a6.1 6.1 0 0 0 3.03 4.87l.84.43c1.58.79 4 .4 5.24-.85l2.36-2.36a12.04 12.04 0 0 1 7.51-3.11A13 13 0 0 1 81 192h-2a11 11 0 0 0-11-11c-1.94 0-4.75 1.16-6.11 2.53l-2.36 2.36a6.93 6.93 0 0 1-7.56 1.22l-.84-.43a8.08 8.08 0 0 1-4.13-6.66V145H11.98a6.1 6.1 0 0 0-4.87 3.03l-.43.84c-.79 1.58-.4 4 .85 5.24l2.36 2.36a12.04 12.04 0 0 1 3.11 7.51A13 13 0 0 1 0 177v-2a11 11 0 0 0 11-11c0-1.94-1.16-4.75-2.53-6.11l-2.36-2.36a6.93 6.93 0 0 1-1.22-7.56l.43-.84a8.08 8.08 0 0 1 6.66-4.13H47v-35.02a6.1 6.1 0 0 0-3.03-4.87l-.84-.43c-1.59-.8-4-.4-5.24.85l-2.36 2.36A12 12 0 0 1 28 109a13 13 0 1 1 0-26c2.47 0 5.79 1.37 7.53 3.11l2.36 2.36a4.94 4.94 0 0 0 5.24.85l.84-.43A6.1 6.1 0 0 0 47 84.02V49H11.98a8.08 8.08 0 0 1-6.66-4.13l-.43-.84a6.91 6.91 0 0 1 1.22-7.56l2.36-2.36A10.06 10.06 0 0 0 11 28 11 11 0 0 0 0 17v-2a13 13 0 0 1 13 13c0 2.47-1.37 5.79-3.11 7.53l-2.36 2.36a4.94 4.94 0 0 0-.85 5.24l.43.84A6.1 6.1 0 0 0 11.98 47H47V11.98a8.08 8.08 0 0 1 4.13-6.66l.84-.43a6.91 6.91 0 0 1 7.56 1.22l2.36 2.36A10.06 10.06 0 0 0 68 11 11 11 0 0 0 79 0h2a13 13 0 0 1-13 13 12 12 0 0 1-7.53-3.11l-2.36-2.36a4.93 4.93 0 0 0-5.24-.85l-.84.43A6.1 6.1 0 0 0 49 11.98V47h35.02a8.08 8.08 0 0 1 6.66 4.13l.43.84a6.91 6.91 0 0 1-1.22 7.56l-2.36 2.36A10.06 10.06 0 0 0 85 68a11 11 0 0 0 22 0c0-1.94-1.16-4.75-2.53-6.11l-2.36-2.36a6.93 6.93 0 0 1-1.22-7.56l.43-.84a8.08 8.08 0 0 1 6.66-4.13H143V11.98a6.1 6.1 0 0 0-3.03-4.87l-.84-.43c-1.59-.8-4-.4-5.24.85l-2.36 2.36A12 12 0 0 1 124 13a13 13 0 0 1-13-13h2a11 11 0 0 0 11 11c1.94 0 4.75-1.16 6.11-2.53l2.36-2.36a6.93 6.93 0 0 1 7.56-1.22l.84.43a8.08 8.08 0 0 1 4.13 6.66V47h35.02a6.1 6.1 0 0 0 4.87-3.03l.43-.84c.8-1.59.4-4-.85-5.24l-2.36-2.36A12 12 0 0 1 179 28a13 13 0 0 1 13-13zM84.02 143a6.1 6.1 0 0 0 4.87-3.03l.43-.84c.8-1.59.4-4-.85-5.24l-2.36-2.36A12 12 0 0 1 83 124a13 13 0 1 1 26 0c0 2.47-1.37 5.79-3.11 7.53l-2.36 2.36a4.94 4.94 0 0 0-.85 5.24l.43.84a6.1 6.1 0 0 0 4.87 3.03H143v-35.02a8.08 8.08 0 0 1 4.13-6.66l.84-.43a6.91 6.91 0 0 1 7.56 1.22l2.36 2.36A10.06 10.06 0 0 0 164 107a11 11 0 0 0 0-22c-1.94 0-4.75 1.16-6.11 2.53l-2.36 2.36a6.93 6.93 0 0 1-7.56 1.22l-.84-.43a8.08 8.08 0 0 1-4.13-6.66V49h-35.02a6.1 6.1 0 0 0-4.87 3.03l-.43.84c-.79 1.58-.4 4 .85 5.24l2.36 2.36a12.04 12.04 0 0 1 3.11 7.51A13 13 0 1 1 83 68a12 12 0 0 1 3.11-7.53l2.36-2.36a4.93 4.93 0 0 0 .85-5.24l-.43-.84A6.1 6.1 0 0 0 84.02 49H49v35.02a8.08 8.08 0 0 1-4.13 6.66l-.84.43a6.91 6.91 0 0 1-7.56-1.22l-2.36-2.36A10.06 10.06 0 0 0 28 85a11 11 0 0 0 0 22c1.94 0 4.75-1.16 6.11-2.53l2.36-2.36a6.93 6.93 0 0 1 7.56-1.22l.84.43a8.08 8.08 0 0 1 4.13 6.66V143h35.02z'%3E%3C/path%3E%3C/svg%3E"); } &.dark { &.patterns { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192' viewBox='0 0 192 192'%3E%3Cpath fill='%23fcfcfc' fill-opacity='0.08' d='M192 15v2a11 11 0 0 0-11 11c0 1.94 1.16 4.75 2.53 6.11l2.36 2.36a6.93 6.93 0 0 1 1.22 7.56l-.43.84a8.08 8.08 0 0 1-6.66 4.13H145v35.02a6.1 6.1 0 0 0 3.03 4.87l.84.43c1.58.79 4 .4 5.24-.85l2.36-2.36a12.04 12.04 0 0 1 7.51-3.11 13 13 0 1 1 .02 26 12 12 0 0 1-7.53-3.11l-2.36-2.36a4.93 4.93 0 0 0-5.24-.85l-.84.43a6.1 6.1 0 0 0-3.03 4.87V143h35.02a8.08 8.08 0 0 1 6.66 4.13l.43.84a6.91 6.91 0 0 1-1.22 7.56l-2.36 2.36A10.06 10.06 0 0 0 181 164a11 11 0 0 0 11 11v2a13 13 0 0 1-13-13 12 12 0 0 1 3.11-7.53l2.36-2.36a4.93 4.93 0 0 0 .85-5.24l-.43-.84a6.1 6.1 0 0 0-4.87-3.03H145v35.02a8.08 8.08 0 0 1-4.13 6.66l-.84.43a6.91 6.91 0 0 1-7.56-1.22l-2.36-2.36A10.06 10.06 0 0 0 124 181a11 11 0 0 0-11 11h-2a13 13 0 0 1 13-13c2.47 0 5.79 1.37 7.53 3.11l2.36 2.36a4.94 4.94 0 0 0 5.24.85l.84-.43a6.1 6.1 0 0 0 3.03-4.87V145h-35.02a8.08 8.08 0 0 1-6.66-4.13l-.43-.84a6.91 6.91 0 0 1 1.22-7.56l2.36-2.36A10.06 10.06 0 0 0 107 124a11 11 0 0 0-22 0c0 1.94 1.16 4.75 2.53 6.11l2.36 2.36a6.93 6.93 0 0 1 1.22 7.56l-.43.84a8.08 8.08 0 0 1-6.66 4.13H49v35.02a6.1 6.1 0 0 0 3.03 4.87l.84.43c1.58.79 4 .4 5.24-.85l2.36-2.36a12.04 12.04 0 0 1 7.51-3.11A13 13 0 0 1 81 192h-2a11 11 0 0 0-11-11c-1.94 0-4.75 1.16-6.11 2.53l-2.36 2.36a6.93 6.93 0 0 1-7.56 1.22l-.84-.43a8.08 8.08 0 0 1-4.13-6.66V145H11.98a6.1 6.1 0 0 0-4.87 3.03l-.43.84c-.79 1.58-.4 4 .85 5.24l2.36 2.36a12.04 12.04 0 0 1 3.11 7.51A13 13 0 0 1 0 177v-2a11 11 0 0 0 11-11c0-1.94-1.16-4.75-2.53-6.11l-2.36-2.36a6.93 6.93 0 0 1-1.22-7.56l.43-.84a8.08 8.08 0 0 1 6.66-4.13H47v-35.02a6.1 6.1 0 0 0-3.03-4.87l-.84-.43c-1.59-.8-4-.4-5.24.85l-2.36 2.36A12 12 0 0 1 28 109a13 13 0 1 1 0-26c2.47 0 5.79 1.37 7.53 3.11l2.36 2.36a4.94 4.94 0 0 0 5.24.85l.84-.43A6.1 6.1 0 0 0 47 84.02V49H11.98a8.08 8.08 0 0 1-6.66-4.13l-.43-.84a6.91 6.91 0 0 1 1.22-7.56l2.36-2.36A10.06 10.06 0 0 0 11 28 11 11 0 0 0 0 17v-2a13 13 0 0 1 13 13c0 2.47-1.37 5.79-3.11 7.53l-2.36 2.36a4.94 4.94 0 0 0-.85 5.24l.43.84A6.1 6.1 0 0 0 11.98 47H47V11.98a8.08 8.08 0 0 1 4.13-6.66l.84-.43a6.91 6.91 0 0 1 7.56 1.22l2.36 2.36A10.06 10.06 0 0 0 68 11 11 11 0 0 0 79 0h2a13 13 0 0 1-13 13 12 12 0 0 1-7.53-3.11l-2.36-2.36a4.93 4.93 0 0 0-5.24-.85l-.84.43A6.1 6.1 0 0 0 49 11.98V47h35.02a8.08 8.08 0 0 1 6.66 4.13l.43.84a6.91 6.91 0 0 1-1.22 7.56l-2.36 2.36A10.06 10.06 0 0 0 85 68a11 11 0 0 0 22 0c0-1.94-1.16-4.75-2.53-6.11l-2.36-2.36a6.93 6.93 0 0 1-1.22-7.56l.43-.84a8.08 8.08 0 0 1 6.66-4.13H143V11.98a6.1 6.1 0 0 0-3.03-4.87l-.84-.43c-1.59-.8-4-.4-5.24.85l-2.36 2.36A12 12 0 0 1 124 13a13 13 0 0 1-13-13h2a11 11 0 0 0 11 11c1.94 0 4.75-1.16 6.11-2.53l2.36-2.36a6.93 6.93 0 0 1 7.56-1.22l.84.43a8.08 8.08 0 0 1 4.13 6.66V47h35.02a6.1 6.1 0 0 0 4.87-3.03l.43-.84c.8-1.59.4-4-.85-5.24l-2.36-2.36A12 12 0 0 1 179 28a13 13 0 0 1 13-13zM84.02 143a6.1 6.1 0 0 0 4.87-3.03l.43-.84c.8-1.59.4-4-.85-5.24l-2.36-2.36A12 12 0 0 1 83 124a13 13 0 1 1 26 0c0 2.47-1.37 5.79-3.11 7.53l-2.36 2.36a4.94 4.94 0 0 0-.85 5.24l.43.84a6.1 6.1 0 0 0 4.87 3.03H143v-35.02a8.08 8.08 0 0 1 4.13-6.66l.84-.43a6.91 6.91 0 0 1 7.56 1.22l2.36 2.36A10.06 10.06 0 0 0 164 107a11 11 0 0 0 0-22c-1.94 0-4.75 1.16-6.11 2.53l-2.36 2.36a6.93 6.93 0 0 1-7.56 1.22l-.84-.43a8.08 8.08 0 0 1-4.13-6.66V49h-35.02a6.1 6.1 0 0 0-4.87 3.03l-.43.84c-.79 1.58-.4 4 .85 5.24l2.36 2.36a12.04 12.04 0 0 1 3.11 7.51A13 13 0 1 1 83 68a12 12 0 0 1 3.11-7.53l2.36-2.36a4.93 4.93 0 0 0 .85-5.24l-.43-.84A6.1 6.1 0 0 0 84.02 49H49v35.02a8.08 8.08 0 0 1-4.13 6.66l-.84.43a6.91 6.91 0 0 1-7.56-1.22l-2.36-2.36A10.06 10.06 0 0 0 28 85a11 11 0 0 0 0 22c1.94 0 4.75-1.16 6.11-2.53l2.36-2.36a6.93 6.93 0 0 1 7.56-1.22l.84.43a8.08 8.08 0 0 1 4.13 6.66V143h35.02z'%3E%3C/path%3E%3C/svg%3E"); } .cover { filter: brightness(0.6); } } .cover { width: auto; height: auto; min-height: 100%; opacity: 0; transition: filter 0.3s, opacity 0.3s; &.loaded { opacity: 1; } }}</style><header class=main-header><nav class="main-nav up top"><div class=nav-all><div class=left-nav><div class=site-name onclick='location.href="/"'>元视角</div></div><div class=nav-center><div class=site-menu><div class=site-menu><div class=menu-item><span class=link-btn>文库</span><div class=link-child><span class=link-child-btn onclick='window.location.href="/archives"'><i class="iconfont icon-guidang"></i>
文章归档
</span><span class=link-child-btn onclick='window.location.href="/categories"'><i class="iconfont icon-folder"></i>
全部分类
</span><span class=link-child-btn onclick='window.location.href="/tags"'><i class="iconfont icon-hashtag"></i>
全部标签</span></div></div><div class=menu-item><span class=link-btn>书影音</span><div class=link-child><span class=link-child-btn onclick='window.location.href="/books"'><i class="iconfont icon-book-fill"></i>
读书
</span><span class=link-child-btn onclick='window.location.href="/movies"'><i class="iconfont icon-movies"></i>
观影
</span><span class=link-child-btn onclick='window.location.href="/musics"'><i class="iconfont icon-music"></i>
听歌</span></div></div><div class=menu-item><span class=link-btn>页面</span><div class=link-child><span class=link-child-btn onclick='window.location.href="/links"'><i class="iconfont icon-people"></i>
友情链接
</span><span class=link-child-btn onclick='window.location.href="/works"'><i class="iconfont icon-people"></i>
个人作品
</span><span class=link-child-btn onclick='window.location.href="/statics"'><i class="iconfont icon-tongji"></i>
站点统计</span></div></div><div class=menu-item><span class=link-btn>更多</span><div class=link-child><span class=link-child-btn onclick='window.location.href="/comments"'><i class="iconfont icon-chat"></i>
留言
</span><span class=link-child-btn onclick='window.location.href="/about"'><i class="iconfont icon-contacts"></i>
关于本站</span></div></div></div></div><span class=site-title>浅析网站 PV/UV 统计系统的原理及其设计</span></div><div class=right-nav><a class="menu-btn nav-btn travellings" title=开往-友链接力 href=https://www.travellings.cn/go.html target=_blank><i class="iconfont icon-subway"></i></a><div class="menu-btn nav-btn" title=随机前往一篇文章 id=randomToggle><i class="iconfont icon-shuffle"></i></div><div class="menu-btn nav-btn" title=全站搜索><i class="iconfont icon-search"></i></div><div class="menu-btn nav-btn" id=themeToggle title=切换主题模式><i class="iconfont icon-sun" id=themeIcon></i></div><div id=open-control class="menu-btn nav-btn pc" title=打开中控台><i class="iconfont icon-dashboard"></i></div><div class="to-top menu-btn hidden" title=返回顶部><div class=to-top-btn><span class=num>0</span>
<i class="iconfont icon-up"></i></div></div><div class="menu-btn nav-btn mobile" title=打开菜单><i class="iconfont icon-toc"></i></div></div></div></nav><div class=mobile-menu id=mobileMenu><div class=menu-mask></div><div class="menu-content s-card"><div class=close-control><i class="iconfont icon-close"></i></div><div class=menu-list><div class=menu-item><span class=link-title>文库</span><div class=link-child><div class=link-child-btn onclick='window.location.href="/archives"'><i class="iconfont icon-guidang"></i>
<span class=name>文章归档</span></div><div class=link-child-btn onclick='window.location.href="/categories"'><i class="iconfont icon-folder"></i>
<span class=name>全部分类</span></div><div class=link-child-btn onclick='window.location.href="/tags"'><i class="iconfont icon-hashtag"></i>
<span class=name>全部标签</span></div></div></div><div class=menu-item><span class=link-title>书影音</span><div class=link-child><div class=link-child-btn onclick='window.location.href="/books"'><i class="iconfont icon-book-fill"></i>
<span class=name>读书</span></div><div class=link-child-btn onclick='window.location.href="/movies"'><i class="iconfont icon-movies"></i>
<span class=name>观影</span></div><div class=link-child-btn onclick='window.location.href="/musics"'><i class="iconfont icon-music"></i>
<span class=name>听歌</span></div></div></div><div class=menu-item><span class=link-title>页面</span><div class=link-child><div class=link-child-btn onclick='window.location.href="/links"'><i class="iconfont icon-people"></i>
<span class=name>友情链接</span></div><div class=link-child-btn onclick='window.location.href="/works"'><i class="iconfont icon-people"></i>
<span class=name>个人作品</span></div><div class=link-child-btn onclick='window.location.href="/statics"'><i class="iconfont icon-tongji"></i>
<span class=name>站点统计</span></div></div></div><div class=menu-item><span class=link-title>更多</span><div class=link-child><div class=link-child-btn onclick='window.location.href="/comments"'><i class="iconfont icon-chat"></i>
<span class=name>留言</span></div><div class=link-child-btn onclick='window.location.href="/about"'><i class="iconfont icon-contacts"></i>
<span class=name>关于本站</span></div></div></div></div></div></div><style>.mobile-menu{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:3000;display:none}.mobile-menu .menu-mask{position:absolute;top:0;left:0;width:100%;height:100%;z-index:-1;background-color:var(--main-mask-background)}.mobile-menu .menu-content{position:absolute;top:0;right:0;height:100%;width:100%;max-width:300px;border-radius:12px 0 0 12px;padding:20px;overflow:auto}.mobile-menu .close-control{position:absolute;top:10px;right:20px;display:flex;align-items:center;justify-content:center;width:35px;height:35px;padding:0;transition:background-color .3s,opacity .3s;border-radius:50%;cursor:pointer}.mobile-menu .close-control .iconfont{font-size:18px;line-height:1;color:var(--main-font-second-color);transition:color .3s,opacity .3s}.mobile-menu .close-control:hover{background-color:var(--main-color)}.mobile-menu .close-control:hover .iconfont{color:var(--main-card-background)}.mobile-menu .menu-list{margin-top:40px}.mobile-menu .menu-item{margin-bottom:12px}.mobile-menu .menu-item .link-title{font-size:14px;margin-bottom:12px;display:inline-block;color:var(--main-font-second-color)}.mobile-menu .menu-item .link-child{display:grid;gap:12px;grid-template-columns:1fr 1fr}.mobile-menu .menu-item .link-child-btn{display:flex;flex-direction:row;justify-content:flex-start;align-items:center;border-radius:8px;padding:10px 12px;background-color:var(--main-card-background);border:1px solid var(--main-card-border);box-shadow:0 8px 16px -4px var(--main-border-shadow);font-size:15px;cursor:pointer;transition:all .3s}.mobile-menu .menu-item .link-child-btn:hover{background-color:var(--main-color);color:var(--main-card-background)}.mobile-menu .menu-item .link-child-btn .iconfont{margin-right:6px;opacity:.6}.mobile-menu .menu-item .link-child-btn .name{max-width:80px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}</style><script>function toggleMobileMenu(){const e=document.getElementById("mobileMenu");e&&(e.style.display=e.style.display==="none"?"block":"none")}</script><div class=modal id=search-modal><div class=modal-mask></div><div class="modal-main s-card" style=max-width:800px><div class=title><div class=title-left><i class="iconfont icon-search"></i>
<span class=title-text>全局搜索</span></div><i class="iconfont icon-close close" id=modal-close></i></div><div class=modal-content style=--height:80vh><div class=search-modal><div class=search-input><input type=text id=search-input placeholder=今天你想搜点什么？ autocomplete=off></div><div class=search-results><div class=search-list></div><div class=search-empty><i class="iconfont icon-search"></i><p>输入关键字，开始搜索</p></div></div><div class=search-hint><span class=text id=search-hint-text></span>
<span class=text><a class=powered_by href=https://www.fusejs.io/ target=_blank>Fuse.js</a></span></div></div></div></div></div></header><main class=main-layout><div class=post><div class=post-meta><div class=meta><div class=categories><a href=/categories/%e6%95%b0%e6%8d%ae%e5%ad%98%e5%82%a8/ class=cat-item><i class="iconfont icon-folder"></i>
<span class=name>数据存储</span></a></div><div class=tags><a href=/tags/%e8%ae%bf%e9%97%ae%e9%87%8f/ class=tag-item><i class="iconfont icon-hashtag"></i>
<span class=name>访问量</span>
</a><a href=/tags/nginx/ class=tag-item><i class="iconfont icon-hashtag"></i>
<span class=name>Nginx</span>
</a><a href=/tags/hyperlog/ class=tag-item><i class="iconfont icon-hashtag"></i>
<span class=name>Hyperlog</span></a></div></div><h1 class=title>浅析网站 PV/UV 统计系统的原理及其设计</h1><div class=other-meta><span class="meta date"><i class="iconfont icon-date"></i>
2019-10-22
</span><span class="update meta"><i class="iconfont icon-time"></i>
2019-10-22
</span><span class="hot meta"><i class="iconfont icon-fire"></i>
<span class=artalk-pv-count id=umami_value_page_pv>0</span>
</span><span class="chat meta hover" data-scroll-to=comments><i class="iconfont icon-chat"></i>
<span id=waline_comments_count class=artalk-comment-count>0</span></span></div></div><div class=post-content><article class="post-article s-card"><div class="expired s-card">本文发表于 <strong>2276</strong> 天前，其中的信息可能已经事过境迁</div><div class="article-gpt s-card"><div class=title><span class=name><i class="iconfont icon-robot"></i>
文章摘要
<i class="iconfont icon-up"></i>
</span><span class=logo>FakeGPT</span></div><div class="content s-card"><span class=text></span></div><div class=meta></div></div><script src=https://npm.elemecdn.com/typeit@8.7.1/dist/index.umd.js></script><script>document.addEventListener("DOMContentLoaded",function(){new TypeIt(".article-gpt .content .text",{strings:"文章主要讨论了如何设计一个 PV/UV 统计系统，以应对互联网产品流量分析的需求。首先介绍了PV（页面浏览量）和 UV（独立访客数）的概念，并探讨了在不同情况下对 PV/UV 的理解，如 AJAX和单页面应用中 PV 的统计方式。接着，提出了在前端通过埋点收集数据的共识，并讨论了后端处理数据的三种方法：使用 Nginx 的 access_log、Redis 的 Hyperloglog 和 LeanCloud 的 Hooks。文章详细描述了这三种方法的实现过程，并通过实例代码展示了如何应用这些技术进行数据统计。最后，作者分享了在设计统计系统时遇到的问题和对使用 Linux 服务器的重要性的认识，并提供了相关项目的 GitHub 链接，供读者参考。",speed:10,lifeLike:!0,waitUntilVisible:!0}).go()})</script><div id=page-content class=markdown-main-style><p>国庆节前有段时间，新浪的“图床”一直不大稳定，因为新浪开启了防盗链，果然免费的永远是最贵的啊。为了不影响使用，我非常粗暴地禁止了浏览器发送 Referer，然后我就发现了一件尴尬的事情，“不蒜子”统计服务无法使用了。这是一件用脚后跟想都能想明白的事情，我禁止了浏览器发送 Referer，而“不蒜子”正好使用 Referer 来识别每个页面，所以，这是一个再明显不过的因为需求变更而引入的 Bug。这个世界最离谱的事情，就是大家都认为程序员是一本“十万个为什么”，每次一出问题就找到程序员这里。其实，程序员是再普通不过的芸芸众生里的一员，人们喜欢听/看到自己愿意去听/看到的事物，而程序员同样喜欢解决自己想去解决的问题。所以，今天的话题是关于如何设计一个 PV/UV 统计系统。OK，Let&rsquo;s Hacking Begin。</p><h1 id=pvuv-的概念>PV/UV 的概念</h1><p>首先，我们从两个最基本的概念 PV 和 UV 开始说起。我们都知道，互联网产品的核心就是流量，前期通过免费的产品吸引目标客户的目的，在积累了一定用户流量以后，再通过广告等增值服务实现盈利，这可以说是互联网产品的典型商业模式啦。而在这个过程中，为了对一个产品的流量进行科学地分析，就产生了譬如访客数(<strong>UV</strong>)、浏览量(<strong>PV</strong>)、访问次数(<strong>VV</strong>)等等的概念，这些概念通常作为衡量流量多少的指标。除此以外，我们还有类似日活跃用户(<strong>DAU</strong>)、月活跃用户(<strong>MAU</strong>)等等这种衡量服务用户粘性的指标，以及平均访问深度、平均访问时间、跳出率等等这种衡量流量质量优劣的指标。如果各位和我一样都写博客的话，对这些概念应该都不会感到陌生，因为我们多多少少会使用到诸如<a href=https://ziyuan.baidu.com/site/index>百度站长</a>、<a href=https://www.umeng.com/>站长统计</a>、<a href=https://ta.qq.com/#/>腾讯统计</a>、<a href="https://developers.google.cn/analytics/devguides/reporting/?hl=zh-cn">Google Analytics</a>这样的统计服务，这些统计服务可以让我们即时掌握博客的访问情况。博主目前使用了<a href=https://ta.qq.com/#/>腾讯统计</a>来查看整个博客的流量情况，而每一篇博客的访问量则是通过**<a href=http://busuanzi.ibruce.info/>“不蒜子”</a>**这个第三方服务，这里再次对作者表示感谢。</p><p><a class=img-fancybox href=https://i.loli.net/2019/10/24/VN2ubT71aLK6eZp.png data-fancybox=gallery data-src=https://i.loli.net/2019/10/24/VN2ubT71aLK6eZp.png data-caption=使用腾讯统计来查看网站的流量情况><img src=https://i.loli.net/2019/10/24/VN2ubT71aLK6eZp.png alt=使用腾讯统计来查看网站的流量情况 class=post-img loading=lazy>
<span class=post-img-tip>使用腾讯统计来查看网站的流量情况</span></a></p><p>回到问题本身，PV，即<strong>Page View</strong>，<strong>表示页面浏览量或者点击量，每当一个页面被打开或者被刷新，都会产生一次 PV，只要这个请求从浏览器端发送到了服务器端</strong>。聪明的各位肯定会想到，如果我写一个爬虫不停地去请求一个页面，那么这个页面的 PV 不就会一直增长下去吗？理论上的确是这样，所以，我们有第二个指标 UV，来作为进一步的参考，所谓 UV，即<strong>Unique Visitor，表示独立访客数</strong>。在上面这个问题中，尽管这个页面的 PV 在不断增长，可是因为这些访客的 IP 都是相同的，所以，这个页面只会产生一次 UV，这就是 PV 和 UV 的区别。所以，我们结合这两个指标，可以非常容易得了解到，这个页面实际的访问情况是什么样的。这让我想起数据分析中的一个例子，虽然以统计学为背景的数学计算不会欺骗人类，可如果人类片面地相信某一个方面的分析结果，数据分析一样是带有欺骗性的。就像有人根据《战狼 2》和《前任 3》两部电影的观众购买冷/热饮的情况，得出下面的结论：<strong>看动作片的观众更喜欢喝冷饮来清凉紧绷着的神经，而看爱情片的观众更喜欢喝热饮来温暖各自的内心</strong>。其实想想就知道这里混淆了因果性和相关性，选择冷饮还是热饮无非是两部电影上映的季节不同而已。</p><h1 id=如何设计一个访问统计系统>如何设计一个访问统计系统</h1><p>OK，了解了 PV 和 UV 的概念后，我们来思考如何去设计一个访问统计系统，这是今天这篇博客的主题内容。我知道，如果问如何设计一个访问系统，大家可能都会不由自主地想到建两张表。的确，这是最简单的做法。可问题是，我们对于 PV 的认识，其实一直都在不断地变化着。比如 PV 的定义是是一个页面被打开或者被刷新时视为一次有效 PV，所以，我们通常的做法是在页面底部嵌入 JavaScript 脚本，这种方式一直工作得非常好。可在引入 AJAX 以后，用户几乎不会主动去刷新页面，那么，在这个过程中用户点击<strong>更多</strong>或者使用<strong>下拉刷新</strong>时，是否应该算作一次有效 PV 呢？甚至在 PC 端网页逐渐式微以后，越来越多的工作转移到手机等移动设备上来，越来越多的原生+Web 混合 App 或者是单页面应用(<strong>SPA</strong>)或者是渐进式应用(<strong>PWA</strong>)，此时我们又该如何认识 PV 呢？微信公众号里的 PV 甚至更为严格，必须通过微信内置的浏览器访问才能算作一次有效 PV。</p><p>可以发现，我们对 PV 的认识其实一直在不断的变化着，更多的时候，我们想追踪的并非页面被加载(<strong>Page Load</strong>)的次数，而是页面被浏览(<strong>Page View</strong>)的次数。这时候，我们可以 Page Visiblity 和 History API 结合的方式。前者在页面的 visibilityState 可见或者由隐藏变为可见时发送一次 Page View，而后者则是在浏览器地址发生变化的时候发送一次 Page View。这听起来非常像单页面应用(<strong>SPA</strong>)里前端路由的那套玩法，的确，当一个地址中的 pathname 或者 search 部分发生变化时，应该发送一次 Page View 请求，而 hash 部分的变化则应该忽略，因为它表示的是应用内部页面的跳转。对于页面的 visibilityState 由隐藏变为可见，不同的人有不同的看法，因为有时我们像合并多次 Page View，而有时候则想通过 Page View 了解所谓的”回头客“，所以，这里面还可以继续引入 Session 的概念，比如 Google Analytics 默认会在 30 分钟内无交互的情况下结束。所以，这个问题要考虑的东西实际上比想象中的要多。</p><p>现在，我们至少可以前端部分达成共识，即通过在前端页面上埋点的方式收集 PV 和 UV。就像我们设计一个 Page View 的表结构会非常简单，而一旦要开始考虑 Unique Visitor，可能我们就需要收集诸如 IP、省市、UA 等等的信息，这些信息的数量会非常大，而 Page View 的数据规模实际上取决于一个站点下有多少个页面。所以，这些数据在后端要怎么样处理，这是我们接下来要去考虑的问题。直接去写数据库是万不得已的做法，因为如果你处理不好并发的问题，这些统计数据的正确性就会让人产生怀疑，所以，接下来，我们介绍三种不同的方法来处理这类问题，它们分别是：通过 Nginx 的 access_log 实现统计、通过 Redis 的 Hyperlog 实现统计，以及通过 LeanCloud 的 Hook 实现统计。同大家一样，我是第一次考虑这类问题，如果有什么不周到的地方，希望大家可以谅解。</p><h2 id=通过-nginx-的-access_log-实现统计>通过 Nginx 的 access_log 实现统计</h2><p>我们首先来介绍 Nginx 的 access_log，顾名思义，这是 Nginx 的访问日志，由 ngx_http_log_module 模块提供相应功能。Nginx 会把每一个用户访问网站的日志信息记录到指定文件里，从而帮助网站提供者分析用户的浏览行为。而 PV/UV 则是分析用户的浏览行为的最基础指标，所以，通过 Nginx 的访问日志来统计 UV 和 PV 是再合适不过的啦！在 Nginx 里主要使用<code>log_format</code>和<code>access_log</code> 两条指令来完成相关的配置。这里以博主自己使用的配置为例来说明：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>    log_format main <span class=s1>&#39;$remote_addr - $remote_user [$time_iso8601] &#34;$request&#34; &#39;</span>
</span></span><span class=line><span class=cl>                      <span class=s1>&#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;</span>
</span></span><span class=line><span class=cl>                      <span class=s1>&#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                      
</span></span><span class=line><span class=cl>    access_log logs/access.log main<span class=p>;</span>
</span></span></code></pre></div><p>可以注意到，我们在这里首先通过<code>log_format</code>命令定义了一个日志格式，而这个日志格式则被定义为 main，这表示我们我们可以在 Nginx 的配置文件中定义多个日志格式。它其实就是一个日志模板，相信大家在使用 NLog、Log4Net 这类日志库的时候，都接触过 Layout 这个概念，这里就是 Nginx 中访问日志的 Layout。那么，在定义了这样一个日志格式以后，我们该怎么使用这个日志格式呢？这就要说到下面的<code>access_log</code>指令，它的基本用法就是一个路径 + 一个模板，在这里我们使用了定义好的 main 模板，然后指定了日志路径为：\logs\localhost.access_log.log。当然啦，大家使用 NLog 和 Log4Net 时，日志对应的 Layout 中都会有“变量”这样的概念，同样地，在 Nginx 中我们有一些常用的“变量”：</p><table><thead><tr><th>Nginx 日志变量</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td>$remote_addr</td><td style=text-align:left>记录访问网站的客户端地址</td></tr><tr><td>$http_x_forward_for</td><td style=text-align:left>当前端有代理服务器时，设置 Web 节点记录客户端地址的配置</td></tr><tr><td>$remote_user</td><td style=text-align:left>远程客户端用户名称</td></tr><tr><td>$time_local</td><td style=text-align:left>记录带时区的访问时间</td></tr><tr><td>$request</td><td style=text-align:left>记录用户 HTTP 请求起始行信息</td></tr><tr><td>$status</td><td style=text-align:left>记录用户 HTTP 请求状态码</td></tr><tr><td>$body_bytes_sents</td><td style=text-align:left>记录服务端返回给客户端响应 Body 字节数</td></tr><tr><td>$http_referer</td><td style=text-align:left>记录本次请求是从哪一个链接访问过来的</td></tr><tr><td>$http_user_agent</td><td style=text-align:left>记录客户端类型信息，比如 Chrome、微信等等</td></tr></tbody></table><p>为什么说这些时最常用的“变量”呢？因为通过这些，我们想要统计 PV 和 UV 的想法就能变成现实，关于更多的 Nginx 日志变量，大家可以从这里来了解：<a href=http://nginx.org/en/docs/http/ngx_http_log_module.html>http://nginx.org/en/docs/http/ngx_http_log_module.html</a>。现在，通过 Nginx 托管一个简单的静态页面，然后在浏览器中访问：localhost:9090，此时，我们应该可以在前面设置的日志路径里找到 Nginx 生成的日志文件，它大概长下面这个样子：</p><p><a class=img-fancybox href=https://i.loli.net/2019/10/24/sGT7QYRWariKDHz.png data-fancybox=gallery data-src=https://i.loli.net/2019/10/24/sGT7QYRWariKDHz.png data-caption=Nginx日志长什么样子><img src=https://i.loli.net/2019/10/24/sGT7QYRWariKDHz.png alt=Nginx日志长什么样子 class=post-img loading=lazy>
<span class=post-img-tip>Nginx日志长什么样子</span></a></p><p>OK，现在有日志文件啦，这 PV/UV 到底从哪里来呢？其实，到这里已经无所谓用什么方法啦，因为你可以用 ELK 全家桶把给它收集了去，或是选一门你喜欢的语言用正则给它匹配出来，这都完全没有问题，无非就是一个工具选择的问题。为了简单起见，我们直接用 Shell 命令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#统计指定页面的PV</span>
</span></span><span class=line><span class=cl>grep / localhost.access.log <span class=p>|</span> wc -l
</span></span><span class=line><span class=cl>grep /favicon.ico localhost.access.log <span class=p>|</span> wc -l
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#统计站点PV</span>
</span></span><span class=line><span class=cl>awk <span class=s1>&#39;{print $6}&#39;</span> localhost.access.log <span class=p>|</span> wc -l <span class=c1>#$6表示模板中的第6个变量，即Referer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#统计访客IP</span>
</span></span><span class=line><span class=cl>awk <span class=s1>&#39;{print $1}&#39;</span> localhost.access.log <span class=p>|</span> sort -r <span class=p>|</span>uniq -c <span class=p>|</span>wc -l <span class=c1>#$1表示模板中第一个变量，即客户端IP</span>
</span></span></code></pre></div><p>至此，我们就达到了基于 Nginx 访问日志实现 PV/UV 统计的目的。我知道有同学要问啦，你不是说要在前端通过埋点的方式来收集访客的信息吗，你这说了半天，完全就是说 Nginx 的事情嘛！的确，我们现在可以统计出自己网站的 PV/UV 了，可如果我们想对外提供一个访问统计的服务，我们又该如何做呢？这里简单分享下博主的思路，因为开发环境一直不是很稳定，所以，一直没有时间动手去实践(逃。
<a class=img-fancybox href=https://i.loli.net/2019/11/25/DBj7SxOa8qf1FZH.png data-fancybox=gallery data-src=https://i.loli.net/2019/11/25/DBj7SxOa8qf1FZH.png data-caption=一种PV/UV统计的思路><img src=https://i.loli.net/2019/11/25/DBj7SxOa8qf1FZH.png alt=一种PV/UV统计的思路 class=post-img loading=lazy>
<span class=post-img-tip>一种PV/UV统计的思路</span>
</a>通过这张图片，我们可以大致梳理出整个流程，即前端页面中通过 JavaScript 来调用后端提供的 Analysis Service，此时这个请求会携带一个 Referer 信息，而这个 Referer 对应被访问的站点。注意到这个后端服务经过了一层 Nginx 转发，显然 Nginx 可以获得客户端的 IP 地址，这两个结合起来，表示的就是某个 IP 访问了某个站点，即 PV。像百度站长和腾讯统计会在页面中注入一个 token 或者 Id，主要用途就是确保请求的确是从当前站点中发出的，这就是这类访问统计产品统计的原理。也许在计算 PV/UV 的算法上存在差异，然而核心的原理应该没多大差别啦！</p><h2 id=通过-redis-的-hyperloglog-实现统计>通过 Redis 的 HyperLogLog 实现统计</h2><p>不知道大家有没有发现，统计 PV 其实蛮简单的，因为它只需要对访问量做更新即可。可统计 UV 就会有点麻烦啦，因为同一个人可以多次访问同一篇文章。有时候我们希望统计一天内的访客数，而有时候我们希望统计一周甚至一个月内的访客数，所以，UV 并不像 PV 那样简单，PV 更多的时候是作为一种“汇总”数据，而 UV 则有“实时”的属性。简而言之，我们需要一张表来记录访客数据，博主在设计这张表的时候，更是引入了地理位置、UserAgent 等等相关的字段设计，因为我们会有了解访客来源、访客设备等等一系列“行为”相关的数据记录。对应到数据库的概念，VisitorRecored 这张表实际上是在不停地写入记录的。那么，面对每一个查看实时访客数的请求，我们真的要每次都要去这张表里统计一遍吗？也许我们会想到使用数据库任务去做定时的汇总，或者是任意形式的定时任务譬如 CORN、Hangfire，在这里，我们有更好的选择——HyperLogLog。</p><p>什么是 HyperlLogLog 呢？我们提到的统计 UV 的这个场景，实际上是一个基数计数(Cardinality Counting)的问题，即统计一个集合中不重复的元素个数，例如集合{1,3,5,7,5,7,8}的基数为 5。所以，HyperLogLog 实际上就是一个在误差允许的范围内，快速统计元素数目的算法。为什么说是误差允许范围内呢？因为它来源于一个经典的概率分布——伯努利分布。高中时候，老师讲到这个知识，我们笑称它为“白努力”，因为有一段时间，排列组合属于我怎么学都学不会东西，可不就是白努力吗？HyperLogLog 是在 LogLog 的基础上优化的一种算法，它主要的改进是采用了桶算法作为每一轮伯努利实验的估计值，同时使用调和平均数代替平均数，进而求出最终的估算值。它可以在不存储整个集合的情况下，使用极小的内存统计出集合元素的个数。</p><p>对应到 Redis 里，主要体现在 PFADD、PFCOUNT、PFMERGE 三个命令上。</p><ul><li>PFADD：将多个值存入指定的 HyperLogLog。</li><li>PFCOUNT：获取指定 HyperLogLog 的基数。</li><li>PFMERGE：合并多个 HyperLogLog，合并前与合并后的基数一致(取并集)。</li></ul><p>博主在写这篇博客的时候，基于 LeanCloud 的访问统计<a href=.>LeanCloud-Counter</a>已经再线上运行了一段时间。下面，我们就以这些数据为例来展示下 HyperLogLog 的用法。为了方便起见，我选择使用 Python 来读写 Redis：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=c1># 连接Redis</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>6379</span><span class=p>,</span> <span class=n>db</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查询访客记录</span>
</span></span><span class=line><span class=cl><span class=n>VisitorRecord</span> <span class=o>=</span> <span class=n>leancloud</span><span class=o>.</span><span class=n>Object</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=s1>&#39;VisitorRecord&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>query</span> <span class=o>=</span> <span class=n>VisitorRecord</span><span class=o>.</span><span class=n>query</span>
</span></span><span class=line><span class=cl><span class=n>query</span><span class=o>.</span><span class=n>limit</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>queryResults</span> <span class=o>=</span> <span class=n>query</span><span class=o>.</span><span class=n>find</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对每个页面使用PFADD</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>result</span> <span class=ow>in</span> <span class=n>queryResults</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>pfadd</span><span class=p>(</span><span class=n>result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;page_url&#39;</span><span class=p>),</span><span class=n>result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;visitor_ip&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用PFCOUNT返回每个页面的基数</span>
</span></span><span class=line><span class=cl><span class=n>pageUrls</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:(</span><span class=n>x</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;page_url&#39;</span><span class=p>),</span><span class=n>x</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;page_title&#39;</span><span class=p>),</span><span class=n>r</span><span class=o>.</span><span class=n>pfcount</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;page_url&#39;</span><span class=p>))),</span> <span class=n>queryResults</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>pageUrls</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>pageUrls</span><span class=p>,</span><span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span><span class=n>x</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span><span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>pageUrls</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>10</span><span class=p>])</span>
</span></span></code></pre></div><p>运行完脚本，我们可以统计出访客数目：</p><p><a class=img-fancybox href=https://i.loli.net/2019/11/26/JxUQ9s1EiOlVBCY.png data-fancybox=gallery data-src=https://i.loli.net/2019/11/26/JxUQ9s1EiOlVBCY.png data-caption=使用HyperLogLog统计访客数目><img src=https://i.loli.net/2019/11/26/JxUQ9s1EiOlVBCY.png alt=使用HyperLogLog统计访客数目 class=post-img loading=lazy>
<span class=post-img-tip>使用HyperLogLog统计访客数目</span></a></p><h2 id=通过-leancloud-的-hooks-实现统计>通过 LeanCloud 的 Hooks 实现统计</h2><p>像 Hexo、Jekyll 这类静态博客，本质上是非常依赖 Valine、不蒜子等等的第三方服务，而使用 LeanCloud 作为访问量统计的服务提供商，更是早就在博客圈子里流行了。不过我注意到，这些设计都少都会有一点不足，那就是网上的各种设计都没有实现站点的 PV/UV 统计。当我被迫从”不蒜子“上迁移过来以后，我其实非常想实现一个和”不蒜子“一模一样的统计服务，因为这样子的话，我对博客的修改会非常非常小。所以， 我不得不在现有方案上扩展更多的功能，实现单篇文章的 UV、整个站点的 PV/UV、访客 IP/地理位置、客户端 UA 等的统计功能。</p><p>在这个过程中，我发现 LeanCloud 不支持传统关系型数据库里的 Sum()操作，而我更不想在客户端通过分页去对表记录做 Sum()操作。官方提供了离线分析和云函数，可这两个东西都是商业版里支持的东西。最终我找到了，通过 Hooks 来实现站点 PV/UV 统计的这样一种方法。所谓 Hooks，你可以理解为传统关系型数据库里的触发器，它可以在你更新或者插入某个对象的时候，去做一点额外的工作。所以，单篇文章会根据文章链接+访客 IP 生成一条 UV，而 PV 则是每次打开文章就视为一条 PV。所以，最终的方案是插入访客记录(<strong>VisitorRecord</strong>)时更新文章的对应的访问次数(<strong>VisitorCounter</strong>)，而单篇文章的更新则会触发站点 UV/PV 的更新。听起来有点绕人，我们直接来看下面的代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//新建访客记录时，更新对应的UV记录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>AV</span><span class=p>.</span><span class=nx>Cloud</span><span class=p>.</span><span class=nx>afterSave</span><span class=p>(</span><span class=s1>&#39;VisitorRecord&#39;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span><span class=p>(</span><span class=nx>request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>query</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>AV</span><span class=p>.</span><span class=nx>Query</span><span class=p>(</span><span class=s1>&#39;VisitorCounter&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>page_url</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>object</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;page_url&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;query page_url: &#39;</span> <span class=o>+</span> <span class=nx>page_url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>query</span><span class=p>.</span><span class=nx>equalTo</span><span class=p>(</span><span class=s1>&#39;page_url&#39;</span><span class=p>,</span> <span class=nx>page_url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>query</span><span class=p>.</span><span class=nx>find</span><span class=p>().</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>counters</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>counters</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=nx>counters</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>increment</span><span class=p>(</span><span class=s1>&#39;page_uv&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;increment UV of page_url: &#39;</span> <span class=o>+</span> <span class=nx>page_url</span> <span class=o>+</span> <span class=s2>&#34;, &#34;</span> <span class=o>+</span> <span class=nx>counters</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;page_pv&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>counters</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>save</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//页面PV/UV更新时，更新站点PV/UV
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>AV</span><span class=p>.</span><span class=nx>Cloud</span><span class=p>.</span><span class=nx>afterUpdate</span><span class=p>(</span><span class=s1>&#39;VisitorCounter&#39;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span><span class=p>(</span><span class=nx>request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>page_url</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>object</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;page_url&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>page_url</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=s1>&#39;//&#39;</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>site_url</span> <span class=o>=</span> <span class=nx>page_url</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s1>&#39;//&#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nx>site_url</span> <span class=o>=</span> <span class=nx>site_url</span><span class=p>.</span><span class=nx>substring</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>site_url</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;now to update site PV/UV with: &#39;</span> <span class=o>+</span> <span class=nx>site_url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=nx>object</span><span class=p>.</span><span class=nx>updatedKeys</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=s1>&#39;page_pv&#39;</span><span class=p>)</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>query</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>AV</span><span class=p>.</span><span class=nx>Query</span><span class=p>(</span><span class=s1>&#39;VisitorCounter&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>query</span><span class=p>.</span><span class=nx>equalTo</span><span class=p>(</span><span class=s1>&#39;page_url&#39;</span><span class=p>,</span><span class=nx>site_url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>query</span><span class=p>.</span><span class=nx>find</span><span class=p>().</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>counters</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=nx>counters</span><span class=p>.</span><span class=nx>length</span><span class=o>&gt;</span><span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=nx>counters</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>increment</span><span class=p>(</span><span class=s1>&#39;page_pv&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;update site PV of &#39;</span> <span class=o>+</span> <span class=nx>site_url</span> <span class=o>+</span> <span class=s2>&#34;, &#34;</span> <span class=o>+</span> <span class=nx>counters</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;page_pv&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nx>counters</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>save</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=nx>object</span><span class=p>.</span><span class=nx>updatedKeys</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=s1>&#39;page_uv&#39;</span><span class=p>)</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>query</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>AV</span><span class=p>.</span><span class=nx>Query</span><span class=p>(</span><span class=s1>&#39;VisitorCounter&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>query</span><span class=p>.</span><span class=nx>equalTo</span><span class=p>(</span><span class=s1>&#39;page_url&#39;</span><span class=p>,</span><span class=nx>site_url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>query</span><span class=p>.</span><span class=nx>find</span><span class=p>().</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>counters</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=nx>counters</span><span class=p>.</span><span class=nx>length</span><span class=o>&gt;</span><span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=nx>counters</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>increment</span><span class=p>(</span><span class=s1>&#39;page_uv&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;update site PV of &#39;</span> <span class=o>+</span> <span class=nx>site_url</span> <span class=o>+</span> <span class=s2>&#34;, &#34;</span> <span class=o>+</span> <span class=nx>counters</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;page_uv&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nx>counters</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>save</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><p>实际上这里整个站点的 UV 统计是不严谨的，因为严格地来讲，同一个 IP 访问了同一个站点下的 N 篇文章，它的 UV 严格地来说应该算 1 次，可我们这个方案本身就是向 LeanCloud 妥协的一种做法，就像我这里直接使用了<code>location.href</code>和<code>document.title</code>，它带来的问题就是，一个网站的域名或者链接发生变化的时候，访问统计就会被重置从 0 开始。“不蒜子”本身就有这个问题。所以，博主这个博客从 15 年到现在，总访问量只有 3 万多，就是因为中间更换过两次域名。从我切换到自己写的统计服务以后，我发现每天来读我博客的人居然不少，我实在不忍心写下这种夸自己的句子啊！</p><p>想解决这个问题，并不是没有办法。像博主一开始设计的时候，是打算用每个页面唯一的 Id 来存储的，而这就要通过 HTML5 中的**data-**或者通过 JavaScript 来传参。可当你打算设计一个更通用的东西的时候，这些想法就显得有点多余，我和大部分人一样，喜欢开箱即用的东西，所以，最好它可以像大多数统计服务一样，只需要在页面里加入一行 JavaScript 脚本。所以，最终采用这样的设计是为了最大限度的开箱即用。考虑到“不蒜子”里因为更换域名而导致的访问统计重置的问题，我增加了一个初始化站点 UV/PV 的功能，满足了像博主这样虚荣心爆棚的人的需要。这一刻，我突然觉得，我和产品经理们一样“自信”啊。正如你所看到的这样，博客底部的访问统计已经从“不蒜子”切换到“LeanCloud-Counter”，为此我在博客上增加了<a href=https://leancloud.cn>LeanCloud</a>的链接，也许下一阶段会加上 Heroku，总之，我已经完成了访问统计的平滑切换。关于这个项目，如果大家感兴趣，可以参考这个地址：<a href=https://github.com/qinyuanpei/leancloud-counter>LeanCloud-Counter</a>。</p><h1 id=本文小结>本文小结</h1><p>这篇文章写下来，最大的感受或许是，有一台 Linux 环境的服务器是多么的重要。起初，是在 Windows10 下面的 WSL 里搭了 Docker 环境，再通过 Docker 镜像搭建 Nginx，因为之前的 Consul、ELK 几乎都是这样运作的，而且一直运行的相当稳定，唯一的缺点大概就是 Docker 太容易吃硬盘，有时候难免搞出个内存不足。Nginx 搭好以后，发现需要经常改配置文件，Docker 环境里改起来相当痛苦。直接在 WSL 里安装 Nginx 的话，因为和 Windows 共享端口，和 IIS 明显搞不到一起。想通过 Docker 挂载本机分区，突然想起来 WSL 里的 Docker 只是一个客户端，真正的主角是跑在 Windows 上的 Docker for Windows。最后被迫装了 Windows 版本的 Nginx，果然还是会和 IIS 冲突，我想说，心好累有木有啊_(:з」∠)_。好了，这篇博客总算写完了！</p></div><div class="copyright s-card"><div class=title><span class=post-name>浅析网站 PV/UV 统计系统的原理及其设计</span>
<a :href=https://blog.yuanpei.me/posts/3494408209/ class=post-link target=_blank>https://blog.yuanpei.me/posts/3494408209/</a></div><div class=post-meta><div class=meta-item><span class=tip>作者</span>
<span class=name>飞鸿踏雪</span></div><div class=meta-item><span class=tip>发布于</span>
<span class=name>2019-10-22</span></div><div class=meta-item><span class=tip>更新于</span>
<span class=name>2019-10-22</span></div><div class="meta-item cc"><span class=tip>许可协议</span>
<a class=name href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans target=_blank>CC BY-NC-SA 4.0</a></div></div><span class=meta-tip>署名-非商业性使用-相同方式共享 4.0 国际</span></div><div class=other-meta><div class=all-tags><a href=/tags/%E8%AE%BF%E9%97%AE%E9%87%8F class=tag-item><i class="iconfont icon-hashtag"></i>
<span class=name>访问量</span>
</a><a href=/tags/nginx class=tag-item><i class="iconfont icon-hashtag"></i>
<span class=name>Nginx</span>
</a><a href=/tags/hyperlog class=tag-item><i class="iconfont icon-hashtag"></i>
<span class=name>Hyperlog</span></a></div><a href=https://eqnxweimkr5.feishu.cn/share/base/form/shrcnCXCPmxCKKJYI3RKUfefJre class=report target=_blank><i class="iconfont icon-report"></i>
反馈与投诉</a></div><div class=reward><div class=reward-btn onclick='window.$Modal.show("reward-modal")'><i class="iconfont icon-reward"></i>
<span class=text>赞赏博主</span></div></div><div class=modal id=reward-modal><div class=modal-mask></div><div class="modal-main s-card" style=max-width:430px><div class=title><div class=title-left><i class="iconfont icon-reward"></i>
<span class=title-text>赞赏博主</span></div><i class="iconfont icon-close close" id=modal-close></i></div><div class=modal-content style=--height:80vh><div class=reward-card><div class=thank>🙏 请博主喝一杯咖啡</div><div class=qr><a class=qr-img href=/images/reward/alipay.jpg target=_blank><img src=/images/reward/alipay.jpg alt=支付宝赞赏码><div class=tip><i class="iconfont icon-alipay"></i>
<span>支付宝</span></div></a><a class=qr-img href=/images/reward/wechat.jpg target=_blank><img src=/images/reward/wechat.jpg alt=微信赞赏码><div class=tip><i class="iconfont icon-wechat"></i>
<span>微信</span></div></a></div><div class="all-list s-card hover"><div class=title>赞赏记录</div><div class=tip>赞赏金额将全部用于开源项目维护，以及服务器、域名及各类云服务的开销</div></div></div></div></div></div><div class=related-post><div class=title><span class=name><i class="iconfont icon-star"></i>
相关推荐
</span><span class=shuffle onclick='window.location.href="/posts/3846545990/"'>随便逛逛</span></div><div class=post-lists><article class="post-item s-card simple hover" style=animation-delay:.4s onclick='window.location.href="/posts/integration-of-distributed-tracing-system-and-logging-system/"'><div class=post-content><span class=post-title>浅议分布式链路追踪与日志的整合</span>
<span class=post-desc>最近阅读了一篇关于分布式链路追踪和日志系统整合的文章，主要介绍了在.NET中利用Activity、ActivitySource和ActivityListener等API实现分布式追踪的方法。这些API可以被视为微软对OpenTelemetry规范的实现，其中每个Activity对应一个Span。文章还介绍了如何利用自定义TraceId和NLog.DiagnosticSource等工具实现将TraceId渲染到日志中，以实现更好的日志查询和分析。最后，作者分享了如何利用OpenTelemetry SDK自动采集HttpClient和ASP.NET Core的诊断信息，并探讨了分布式追踪与日志整合的实践方法。文章以深入浅出的方式介绍了相关概念和技术，提供了有关链路追踪和日志系统整合的有益见解。</span></div></article><article class="post-item s-card simple hover" style=animation-delay:.4s onclick='window.location.href="/posts/a-story-of-git-large-file-storage/"'><div class=post-content><span class=post-title>关于 Git 大文件上传这件小事</span>
<span class=post-desc>在这篇文章中，作者分享了在使用Git时遇到的大文件上传问题以及如何应对。作者提到了Git LFS扩展的使用方法，包括安装、追踪文件和提交大文件的步骤。此外，文章还介绍了在提交大文件后如何处理历史记录中的大文件以及通过git filter-branch命令重写提交历史的方法。最后，作者总结了文章的主要内容，强调了对Git LFS和大文件处理的重要性，以及在解决问题过程中可能遇到的挑战。</span></div></article></div><style>.post-lists{width:100%}.post-lists .post-item{padding:0!important;display:flex;margin-bottom:1rem;animation:fade-up .6s backwards;cursor:pointer;overflow:hidden;height:200px}.post-lists .post-item .post-cover{flex:0 0 35%;overflow:hidden;transform:translateZ(0)}.post-lists .post-item .post-cover img{width:100%;height:100%;object-fit:cover;transform-origin:center center;transition:transform .5s ease-out,filter .5s ease-out;backface-visibility:hidden}.post-lists .post-item .post-content{flex:1;padding:1.6rem 2rem;display:flex;flex-direction:column;justify-content:space-between}.post-lists .post-item .post-category{display:flex;flex-wrap:wrap;width:100%;color:var(--main-font-second-color);font-size:14px}.post-lists .post-item .post-category .cat-name{display:flex;flex-direction:row;align-items:center}.post-lists .post-item .post-category .cat-name .iconfont{opacity:.8;margin-right:6px;color:var(--main-font-second-color)}.post-lists .post-item .post-category .top{margin-left:12px;color:var(--main-color)}.post-lists .post-item .post-category .top .iconfont{opacity:.8;color:var(--main-color)}.post-lists .post-item .post-title{font-size:20px;line-height:30px;font-weight:700;margin:.6rem 0;transition:color .3s;display:-webkit-box;overflow:hidden;word-break:break-all;-webkit-box-orient:vertical;-webkit-line-clamp:2}.post-lists .post-item .post-desc{margin-top:-.4rem;margin-bottom:.8rem;opacity:.8;line-height:30px;display:-webkit-box;overflow:hidden;word-break:break-all;-webkit-box-orient:vertical;-webkit-line-clamp:2}.post-lists .post-item .post-meta{display:flex;flex-direction:row;align-items:center;justify-content:space-between;color:var(--main-font-second-color)}.post-lists .post-item .post-tags{display:flex;flex-wrap:wrap;opacity:.8;margin-right:20px;overflow:hidden;mask:linear-gradient(90deg,#fff 0,#fff 90%,hsla(0,0%,100%,.6) 95%,hsla(0,0%,100%,0) 100%)}.post-lists .post-item .post-tags .tags-name{display:flex;flex-direction:row;align-items:center;margin-right:12px;white-space:nowrap;transition:color .3s}.post-lists .post-item .post-time{opacity:.6;font-size:13px;white-space:nowrap}.post-lists .post-item:hover .post-cover img{filter:brightness(.8);transform:scale(1.05)}.post-lists .post-item:hover .post-title{color:var(--main-color)}.post-lists .post-item:active{transform:scale(.98)}.post-lists .post-item.cover-left{flex-direction:row}.post-lists .post-item.cover-right{flex-direction:row-reverse}.post-lists .post-item.cover-both:nth-child(odd){flex-direction:row}.post-lists .post-item.cover-both:nth-child(even){flex-direction:row-reverse}.post-lists.layout-grid{display:grid;grid-template-columns:repeat(var(--grid-columns,2),1fr);gap:var(--grid-gap,1rem)}.post-lists.layout-grid .post-item{margin:0;flex-direction:column;height:auto}.post-lists.layout-grid .post-item .post-cover{flex:none;width:100%;height:225px}@media(max-width:768px){.post-lists .post-item{flex-direction:column;height:auto}.post-lists .post-item .post-cover{flex:none;width:100%;height:200px}.post-lists .post-item.cover-left,.post-lists .post-item.cover-right,.post-lists .post-item.cover-both{flex-direction:column!important}.post-lists.layout-grid{grid-template-columns:1fr}.post-lists .post-item .post-tags{flex-wrap:nowrap}}.post-lists .post-item .simple{animation:none;padding:.5rem 1.4rem!important;background-color:var(--main-card-second-background);height:auto;margin-bottom:.5rem}.post-lists .post-item .simple .post-content{padding:.5rem 0}.post-lists .post-item .simple .post-title{margin:0;font-size:16px}.post-lists .post-item .simple .post-desc{margin:.3rem 0 0;font-size:14px;opacity:.6}</style></div><style>.related-post{margin-top:1rem}.related-post .title{display:flex;flex-direction:row;align-items:center;justify-content:space-between;width:100%;margin:3rem 0 1rem;padding:0 6px}.related-post .title .name{display:flex;align-items:center;font-size:24px;font-weight:700}.related-post .title .name .iconfont{font-size:26px;font-weight:400;margin-right:8px}.related-post .title .shuffle{opacity:.6;font-size:14px;transition:color .3s,opacity .3s;cursor:pointer}.related-post .title .shuffle:hover{opacity:1;color:var(--main-color)}</style><div id=comments><div id=main-comment class=comment style=padding-left:1.5rem;padding-right:1.5rem><div v-if=!fill class=title><span class=name><i class="iconfont icon-chat"></i>
评论
</span><span class=tool>隐私政策</span></div><link rel=stylesheet href=https://unpkg.com/@waline/client@v3/dist/waline.css><div id=waline class=waline-container></div><style>.waline-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}.waline-container .vcount{color:var(--card-text-color-main)}.waline-container .wl-content img{width:unset!important;max-width:unset!important;max-height:unset!important;border-radius:unset!important}.waline-container .wl-content p{font-size:.9rem!important}.wl-header label{font-size:.8em}.wl-sort li{font-size:.8em}</style><script type=module>
        import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';
        init({
            el: '#waline',
            serverURL: 'https:\/\/waline.yuanpei.me\/',
            lang: 'zh',
            dark: 'auto',
            path: window.location.href,
            requiredMeta: ['nick','mail'],
            emoji: [
                '//unpkg.com/@waline/emojis@1.2.0/weibo'
            ],
            reaction: false,
        });
      </script></div></div><div class="next-post s-card" id=next-post data-is-next=true><a href=/posts/369095810/ class=next-post-link><span class=post-tip>下一篇阅读
</span><span class=post-title>Valine 搭配 Server 酱实现博客评论推送</span></a></div></article><aside class=main-aside><div class="hello s-card weidgets"><span class=tip id=hello-weidget-tip>好久不见</span><div class=content><div class=site-logo><div class=avatar><img src=/images/avatar.jpg alt=avatar loading=lazy></div></div><span class=site-desc>谢谢你，在这世界的角落，找到我。我是一位穿梭于数字与人文领域交界处的观察者，热衷于在数字迷雾中剖析谜题背后的真相，同时在人文星河中重拾温暖和光明。我期待，在元视角的坐标系下，找到理性思考与感性体验共鸣完美平衡的交汇点。</span></div><div class=info><div class=name><span class=author>飞鸿踏雪</span>
<span class=desc>纵有疾风起，人生不言弃</span></div><div class=link><a href=https://github.com/qinyuanpei target=_blank class=social-link aria-label=GitHub><i class="iconfont icon-github"></i>
</a><a href=mailto:qinyuapei@163.com target=_blank class=social-link aria-label=Email><i class="iconfont icon-email"></i></a></div></div></div><div class=sticky><div class="toc s-card weidgets" id=weidget-toc><div class=toc-title><i class="iconfont icon-toc"></i>
<span class=name>目录</span></div><div id=toc-all class=toc-list></div></div><script>document.addEventListener("DOMContentLoaded",function(){const o=[];let e=null,t=null,n=0;const s=document.getElementById("toc-all"),i=()=>{try{if(e=document.getElementById("page-content"),!e)return!1;const t=Array.from(e.querySelectorAll("h1, h2, h3, h4")).filter(e=>e.parentElement.tagName.toLowerCase()==="div");return t}catch(e){console.error("获取所有目录数据出错：",e)}},r=()=>{const e=i();if(!e)return!1;s.innerHTML="",e.forEach((e,t)=>{const n={id:e.id,type:e.tagName,text:e.textContent?.replace(/\u200B/g,"").trim()},i=document.createElement("span");i.id="toc-"+n.id,i.className=`toc-item ${n.type} ${t===0?"active":""}`,i.textContent=n.text,i.addEventListener("click",()=>d(n.id)),s.appendChild(i),o.push(n)}),e&&e.length>0&&(t=e[0].id)},c=(e,t)=>{let n;return function(){const s=arguments,o=this;n||(e.apply(o,s),n=!0,setTimeout(()=>n=!1,t))}},l=c(()=>{if(!o.length)return!1;const e=i();if(!e)return!1;const s=120;if(window.scrollY===0){n=0,t=e[0]?.id,a();return}for(let n of e){const o=n.getBoundingClientRect();o.top-s<=0&&o.bottom+s>=0&&t!==n.id&&(t=n.id,a())}},100),a=()=>{document.querySelectorAll(".toc-item.active").forEach(e=>{e.classList.remove("active")});const e=document.getElementById("toc-"+t);if(!e)return!1;e.classList.add("active"),n=e.offsetTop-2||0,s.style.setProperty("--height",n+"px"),s.scrollTo({top:n-80,behavior:"smooth"})},d=t=>{try{const n=document.getElementById(t);if(!n||!e)return!1;const s=n.offsetTop,o=s+e.offsetTop-80;window.scroll({top:o,behavior:"smooth"})}catch(e){console.error("目录滚动失败：",e)}};r(),window.addEventListener("scroll",l)})</script><style lang=scss scoped>.toc{position:relative;padding:0!important;overflow:hidden;.toc-title { display: flex; flex-direction: row; align-items: center; padding: 18px; height: 58px; .iconfont { margin-right: 8px; font-weight: bold; opacity: 0.6; } .name { font-weight: bold; } } .toc-list { position: relative; padding: 20px; padding-top: 0; padding-left: 24px; display: flex; flex-direction: column; max-height: calc(70vh - 58px); overflow: auto; .toc-item { margin: 4px 0; padding: 6px 12px; border-radius: 8px; opacity: 0.6; transition: color 0.3s, opacity 0.3s, font-size 0.3s, background-color 0.3s; cursor: pointer; &:first-child { margin-top: 0; } &:last-child { margin-bottom: 0; } &.H1 { font-weight: bold; } &.H2 { font-size: 14px; margin-left: 15px; font-weight: normal; } &.H3 { font-size: 12px; margin-left: 25px; } &.active { opacity: 1; color: var(--main-color); background-color: var(--main-color-bg); &.H2 { font-size: 14px; } &.H3 { font-size: 12px; } } &:hover { opacity: 1; color: var(--main-color); background-color: var(--main-color-bg); } } &::after { content: ""; position: absolute; left: 12px; top: var(--height); width: 4px; height: 20px; margin: 8px 0; background-color: var(--main-color); border-radius: 8px; transition: top 0.3s; } } &::before { content: ""; position: absolute; left: 12px; bottom: 20px; width: 4px; height: calc(100% - 78px); background-color: var(--main-card-border); border-radius: 8px; }}</style><div class="tags-cloud s-card weidgets"><div class=title><i class="iconfont icon-hashtag"></i>
<span class=title-name>热门标签</span></div><div class=all-tags><a href=/tags/orm/ class=tags><span class=name>ORM</span>
<sup class=num>1</sup>
</a><a href=/tags/blazor/ class=tags><span class=name>Blazor</span>
<sup class=num>1</sup>
</a><a href=/tags/form/ class=tags><span class=name>Form</span>
<sup class=num>1</sup>
</a><a href=/tags/%E5%AE%A1%E8%AE%A1/ class=tags><span class=name>审计</span>
<sup class=num>1</sup>
</a><a href=/tags/%E5%85%AB%E5%8D%A6/ class=tags><span class=name>八卦</span>
<sup class=num>1</sup>
</a><a href=/tags/%E7%94%9F%E6%AD%BB/ class=tags><span class=name>生死</span>
<sup class=num>1</sup>
</a><a href=/tags/thoughtworks/ class=tags><span class=name>ThoughtWorks</span>
<sup class=num>1</sup>
</a><a href=/tags/%E7%94%BB%E5%AE%B6/ class=tags><span class=name>画家</span>
<sup class=num>2</sup>
</a><a href=/tags/%E6%80%9D%E8%80%83/ class=tags><span class=name>思考</span>
<sup class=num>5</sup>
</a><a href=/tags/%E6%97%A5%E5%BF%97/ class=tags><span class=name>日志</span>
<sup class=num>5</sup>
</a><a href=/tags/retrofit/ class=tags><span class=name>Retrofit</span>
<sup class=num>1</sup>
</a><a href=/tags/%E7%9C%9F%E5%AE%9E/ class=tags><span class=name>真实</span>
<sup class=num>1</sup>
</a><a href=/tags/%E4%BA%A4%E4%BA%92/ class=tags><span class=name>交互</span>
<sup class=num>1</sup>
</a><a href=/tags/%E5%A4%9A%E7%A7%9F%E6%88%B7/ class=tags><span class=name>多租户</span>
<sup class=num>1</sup>
</a><a href=/tags/pgvector/ class=tags><span class=name>Pgvector</span>
<sup class=num>1</sup>
</a><a href=/tags/web/ class=tags><span class=name>Web</span>
<sup class=num>4</sup>
</a><a href=/tags/%E9%95%BF%E5%AE%89%E5%8D%81%E4%BA%8C%E6%97%B6%E8%BE%B0/ class=tags><span class=name>长安十二时辰</span>
<sup class=num>1</sup>
</a><a href=/tags/%E6%A8%A1%E6%9D%BF/ class=tags><span class=name>模板</span>
<sup class=num>1</sup>
</a><a href=/tags/openai/ class=tags><span class=name>OpenAI</span>
<sup class=num>1</sup>
</a><a href=/tags/%E6%89%93%E5%8D%B0/ class=tags><span class=name>打印</span>
<sup class=num>2</sup>
</a><a href=/tags/%E6%8E%A2%E7%B4%A2/ class=tags><span class=name>探索</span>
<sup class=num>1</sup>
</a><a href=/tags/sqlite/ class=tags><span class=name>SQLite</span>
<sup class=num>1</sup>
</a><a href=/tags/httpclient/ class=tags><span class=name>HttpClient</span>
<sup class=num>2</sup>
</a><a href=/tags/%E5%BC%82%E5%B8%B8/ class=tags><span class=name>异常</span>
<sup class=num>3</sup>
</a><a href=/tags/kafka/ class=tags><span class=name>Kafka</span>
<sup class=num>2</sup>
</a><a href=/tags/printdocument/ class=tags><span class=name>PrintDocument</span>
<sup class=num>1</sup>
</a><a href=/tags/%E6%9C%B4%E7%B4%A0%E8%B4%9D%E5%8F%B6%E6%96%AF/ class=tags><span class=name>朴素贝叶斯</span>
<sup class=num>1</sup>
</a><a href=/tags/kindle/ class=tags><span class=name>Kindle</span>
<sup class=num>3</sup>
</a><a href=/tags/websocket/ class=tags><span class=name>WebSocket</span>
<sup class=num>3</sup>
</a><a href=/tags/mysql/ class=tags><span class=name>MySQL</span>
<sup class=num>2</sup>
</a><a href=/tags/cts/ class=tags><span class=name>CTS</span>
<sup class=num>1</sup>
</a><a href=/tags/ddd/ class=tags><span class=name>DDD</span>
<sup class=num>1</sup>
</a><a href=/tags/fp/ class=tags><span class=name>FP</span>
<sup class=num>1</sup>
</a><a href=/tags/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/ class=tags><span class=name>函数式编程</span>
<sup class=num>1</sup>
</a><a href=/tags/aop/ class=tags><span class=name>AOP</span>
<sup class=num>7</sup>
</a><a href=/tags/%E8%B0%83%E8%AF%95/ class=tags><span class=name>调试</span>
<sup class=num>1</sup>
</a><a href=/tags/%E5%8F%8D%E7%BC%96%E8%AF%91/ class=tags><span class=name>反编译</span>
<sup class=num>1</sup>
</a><a href=/tags/%E4%BA%BA%E7%94%9F/ class=tags><span class=name>人生</span>
<sup class=num>2</sup>
</a><a href=/tags/excel/ class=tags><span class=name>Excel</span>
<sup class=num>1</sup>
</a><a href=/tags/%E5%85%A8%E6%99%BA%E8%B4%A4/ class=tags><span class=name>全智贤</span>
<sup class=num>1</sup>
</a><a href=/tags/gephi/ class=tags><span class=name>Gephi</span>
<sup class=num>1</sup>
</a><a href=/tags/%E6%95%B0%E6%8D%AE%E4%BA%A4%E6%8D%A2/ class=tags><span class=name>数据交换</span>
<sup class=num>1</sup>
</a><a href=/tags/%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7/ class=tags><span class=name>奇技淫巧</span>
<sup class=num>1</sup>
</a><a href=/tags/nginx/ class=tags><span class=name>Nginx</span>
<sup class=num>3</sup>
</a><a href=/tags/hexo/ class=tags><span class=name>Hexo</span>
<sup class=num>8</sup>
</a><a href=/tags/%E5%89%8D%E7%AB%AF/ class=tags><span class=name>前端</span>
<sup class=num>9</sup>
</a><a href=/tags/%E8%AF%AD%E6%B3%95/ class=tags><span class=name>语法</span>
<sup class=num>1</sup>
</a><a href=/tags/%E6%A1%8C%E9%9D%A2/ class=tags><span class=name>桌面</span>
<sup class=num>1</sup>
</a><a href=/tags/%E7%94%B5%E5%BD%B1/ class=tags><span class=name>电影</span>
<sup class=num>12</sup>
</a><a href=/tags/json/ class=tags><span class=name>JSON</span>
<sup class=num>1</sup></a></div><a href=/tags class=more-tags>查看全部</a></div><div class="site-data s-card weidgets"><div class=title><i class="iconfont icon-chart"></i>
<span class=title-name>站点数据</span></div><div class=all-data><div class=data-item><span class=name><i class="iconfont icon-article"></i>
文章总数
</span><span class=num>282 篇</span></div><div class=data-item><span class=name><i class="iconfont icon-date"></i>
建站天数
</span><span class=num>4033 天</span></div><div class=data-item><span class=name><i class="iconfont icon-words"></i>
全站字数
</span><span class=num>109213 字</span></div><div class=data-item><span class=name><i class="iconfont icon-visibility"></i>
总访问量
</span><span class=num id=umami_value_site_pv></span></div><div class=data-item><span class=name><i class="iconfont icon-account"></i>
总访客数
</span><span class=num id=umami_value_site_uv></span></div></div></div></div></aside><style>.main-aside{padding-left:1rem;display:flex;flex-direction:column;animation:fade-up .6s .3s backwards;.weidgets { padding: 18px; margin-bottom: 1rem; :deep(.title) { margin-bottom: 12px; font-weight: bold; display: flex; align-items: center; opacity: 0.75; .iconfont { opacity: 0.6; margin-right: 6px; } .title-name { opacity: 0.8; } } } .sticky { position: sticky; top: calc(60px + 1rem); .weidgets { animation: fade-up 0.6s 0.4s backwards; &:last-child { margin-bottom: 0; } } }}</style></div></div></main><div class=footer-link><div class=footer-bar><span class=site-title>元视角</span>
<span class=site-desc>纵有疾风起，人生不言弃</span>
<a href=/ class=to-home>了解更多</a></div><div class=footer-social><a href=https://github.com/qinyuanpei target=_blank class=social-link aria-label=GitHub><i class="iconfont icon-github"></i>
</a><a href=mailto:qinyuanpei@163.com target=_blank class=social-link aria-label=Email><i class="iconfont icon-email"></i>
</a><a href=/index.xml target=_blank class=social-link aria-label=RSS><i class="iconfont icon-rss"></i></a><div class=logo title=返回顶部 onclick='window.scrollTo({top:0,behavior:"smooth"})'><img src=/images/icons8-stellar-128.png alt=author class=author></div><a href=https://weibo.com/1278609231 target=_blank class=social-link aria-label=微博><i class="iconfont icon-weibo"></i>
</a><a href=https://www.douban.com/people/60029335/ target=_blank class=social-link aria-label=豆瓣><i class="iconfont icon-douban"></i>
</a><a href=https://www.zhihu.com/people/qinyuanpei target=_blank class=social-link aria-label=知乎><i class="iconfont icon-zhihu"></i></a></div><div class=footer-sitemap><div class=sitemap-item><span class=title>博客</span><div class=links><a href=/archives class=link-text>文章归档
</a><a href=/categories class=link-text>全部分类
</a><a href=/tags class=link-text>全部标签</a></div></div><div class=sitemap-item><span class=title>项目</span><div class=links><a href=https://github.com/qinyuanpei/mcp-server-weibo target=_blank class=link-text>mcp-server-weibo</a></div></div><div class=sitemap-item><span class=title>专栏</span><div class=links><a href=https://blog.csdn.net/qinyuanpei/category_10852603.html target=_blank class=link-text>.NET 源代码探案系列
</a><a href=https://blog.csdn.net/qinyuanpei/category_7444699.html target=_blank class=link-text>Python 数据挖掘系列
</a><a href=https://blog.csdn.net/qinyuanpei/category_11484903.html target=_blank class=link-text>分布式丛林探险系列
</a><a href=https://blog.csdn.net/qinyuanpei/category_1708629.html target=_blank class=link-text>Unity3D 游戏开发系列</a></div></div><div class=sitemap-item><span class=title>页面</span><div class=links><a href=/comments class=link-text>留言
</a><a href=/books class=link-text>读书
</a><a href=/movies class=link-text>观影
</a><a href=/musics class=link-text>听歌</a></div></div><div class=sitemap-item><span class=title>友情链接</span><div class=links><a href=https://gudong.site/ target=_blank class=link-text>咕咚同学
</a><a href=https://coolshell.cn/ target=_blank class=link-text>酷壳
</a><a href=https://blog.zhheo.com/ target=_blank class=link-text>张洪
</a><a href=/links class=link-text>更多</a></div></div></div></div><footer id=main-footer class=main-footer><div class=footer-content><div class=footer-copyright><span class=time data-v-6001e979>@ 2014 - 2025 </span><a href=/ class="author link" target=_blank>飞鸿踏雪</a></div><div class=meta><a class="power link" href=https://gohugo.io/ target=_blank><span class=by>Powered by</span>
<span class=name>Hugo</span>
</a><a class="theme link" href=https://github.com/imsyy/vitepress-theme-curve><span class=name>主题</span>
</a><a class="rss link" href=/index.xml target=_blank><i class="iconfont icon-rss"></i>
<span class=name data-v-6001e979>订阅</span>
</a><a class="cc link" href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans target=_blank aria-label="Creative Commons"><i class="iconfont icon-line"></i>
<i class="iconfont icon-by-line"></i>
<i class="iconfont icon-nc-line"></i>
<i class="iconfont icon-nd-line"></i></a></div></div></footer><script type=module src=/scripts/main.js></script><script src=https://cdn.jsdelivr.net/npm/fuse.js@7.1.0></script><script src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/highlight.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/styles/github-dark.min.css media="(prefers-color-scheme: dark)"><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/styles/github.min.css media="(prefers-color-scheme: light)"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css><script src=https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js></script><script src=https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js></script><script type=text/javascript src=/scripts/modules/badge.js></script><script type=text/javascript>window.createBadge("Hugo","v0.126.1","#35495e","#41b883"),window.createBadge("Github","1ae5ebb","#35495e","#ffc107")</script></body></html>